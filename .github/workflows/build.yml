name: build

on:
  workflow_dispatch:

jobs:
  windows:
    name: ${{ matrix.btype }} Windows
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        arch: [x86_64]
        cc: [gcc]
        btype: [Release]
        include:
          - btype: Release
            rule: install

          - arch: x86_64

    steps:

    - name: Install tools
      run: |
          sudo apt-get -qq update
          sudo apt-get -y install mesa-common-dev libxxf86dga-dev libxrandr-dev libxxf86vm-dev libasound-dev libsdl2-dev mingw-w64 g++-mingw-w64

    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Build
      run: |
        make ${{ matrix.rule }} -j8 ARCH=${{ matrix.arch }} PLATFORM=mingw64 CC=x86_64-w64-mingw32-gcc DESTDIR=bin RENDERER_DEFAULT=opengl

    - uses: actions/upload-artifact@v4
      if: matrix.btype == 'release'
      with:
        name: windows
        path: bin
        if-no-files-found: error
        retention-days: 5

  ubuntu:
    name: ${{ matrix.btype }} Ubuntu
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        arch: [x86_64]
        cc: [gcc]
        btype: [Release]
        include:
          - btype: Release
            rule: install

          - arch: x86_64

    steps:

    - name: Install tools
      run: |
          sudo apt-get -qq update
          sudo apt-get -y install mesa-common-dev libxxf86dga-dev libxrandr-dev libxxf86vm-dev libasound-dev libsdl2-dev

    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Build
      if: ${{ github.event_name != 'release' || matrix.btype != 'Debug' }} # skip in Release builds
      run: |
        make ${{ matrix.rule }} -j 8 ARCH=${{ matrix.arch }} CC=${{ matrix.cc }} DESTDIR=bin RENDERER_DEFAULT=opengl

    - uses: actions/upload-artifact@v4
      if: matrix.cc == 'gcc' && matrix.btype == 'release'
      with:
        name: linux
        path: bin
        if-no-files-found: error
        retention-days: 5